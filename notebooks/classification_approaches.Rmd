---
title: "Classification Approaches Comparison"
author: "Dima"
date: "September 14, 2015"
output: html_document
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(njtPredict)
library(lubridate)
library(ggplot2)
library(tidyr)
library(knitr)
library(caret)
# devtools::load_all() #Toggle if not in the mood to rebuild after change
data("njt_features")

opts_chunk$set(echo = TRUE,
               message = FALSE,
               prompt = FALSE,
               warning = FALSE,
               cache = TRUE)
```

```{r feature_cleanup}
tr_data <- njt_features %>% 
  # select(is_delayed, Line, dep_hour, dep_mon, dep_wday, prdelay, Temp_F, Visibility, WindSpeed, HourlyPrecip) %>%
  ungroup %>% 
  mutate(Line = gsub(" " , "_", Line),
         is_delayed = factor(is_delayed, levels = c(TRUE,FALSE), labels = c("Yes","No"))) %>% 
  # Need to remove these fields for the complete.cases function (not a feature I'll use anyway) 
  select(-Actual_End_Time, -delay_length, -ttl_dep_arv_line)
tr_data <- tr_data[complete.cases(tr_data), ] #Removes only about 8K entries

#Using downsampling per "Line" to account for the Unbalanced training data
tr_ds <- tr_data %>% group_by(Line) %>% do(downSample(., .$is_delayed))
```

# Preparing for Model Resampling
```{r}
train_control <- trainControl(method = "repeatedcv",
                           number = 5,
                           repeats = 10,
                           ## Estimate class probabilities
                           classProbs = TRUE,
                           ## Evaluate performance using 
                           ## the following function
                           summaryFunction = twoClassSummary)

logit_fit <- train(Class ~ Line + as.factor(dep_hour) + as.character(dep_wday) + dep_mon + ttl_line +  Temp_F + Visibility + WindSpeed,
                   data = training,
                   method = "glm",
                   family = "binomial",
                   metric = "ROC",
                   trControl = train_control)
# pred <-  predict(logit_fit, training)
# confusionMatrix(pred, training$Class)
rf_fit <- train(Class ~ as.factor(dep_hour) + as.character(dep_wday) + dep_mon + ttl_line +  Temp_F + Visibility + WindSpeed,
                data = training,
                method = "rf",
                ntree = 80,
                metric = "ROC",
                trControl = train_control)
# tr_ctrl <- trainControl(method="cv", number=5, savePred = TRUE, classProb = TRUE)
```









```{r}
testModel <- function(df, tr_ctrl, method = "glm", formula, ...){
  ds_df <- df %>% droplevels()
  fit <- train(formula, data = ds_df, method = method, trControl = tr_ctrl, ...)
  pred <-  predict(fit, ds_df)
  cm <- confusionMatrix(pred, ds_df$Class)
  
  # Get AUC per Fold
  roc_eval <- fit$pred %>% 
    group_by(Resample) %>% 
    arrange(desc(Yes)) %>% 
    mutate(obs = ifelse(obs == "Yes",1,0)) %>%
    summarise(auc = auc(roc(obs,Yes)))
  roc_vec <- as.vector(roc_eval$auc)
  names(roc_vec) <- roc_eval$Resample
  data.frame(t(c(cm$overall, cm$byClass, roc_vec)))
}

#Using all data
results_dslogit_all <- testModel(tr_ds, tr_ctrl, method = "glm", family = "binomial", formula)

# results_dslogit_byline <- tr_ds %>% group_by(Line) %>% do(testModel(.,tr_ctrl, method = "glm", family = "binomial", formula))

```

```{r}

```




# Random Forest

```{r}
rf_fit <- train(formula, data = tr_ds, method = "rf", trControl = tr_ctrl, ntree = 80)
rf_pred <-  predict(rf_fit, tr_ds)
cm <- confusionMatrix(rf_pred, tr_ds$Class)
plot(varImp(rf_fit))
rf_fit -> modelfit
save(modelfit, file = "../../DelayPredictor/modelfit.rda")
```

## Separate Holdout
```{r}
in_train <- createDataPartition(tr_ds$Class, p=.75, list=FALSE)
rf_fit_ho <- train(formula, data = tr_ds, method = "rf", trControl = tr_ctrl, ntree = 80, subset = in_train)
# rf_pred_ho <-  predict(rf_fit_ho, tr_ds[-in_train,])
test = tr_ds[-in_train,]
test$pred = predict(rf_fit_ho, tr_ds[-in_train,], "raw")
confusionMatrix(test$pred, test$Class)


testModelHoldout <- function(df, tr_ctrl, method = "glm", formula, ...){
  ds_df <- df %>% droplevels()
  in_partition <- createDataPartition(ds_df$Class, p=.75, list=FALSE)
  fit <- train(formula, data = ds_df, method = method, trControl = tr_ctrl, subset = in_partition, ...)
  
  test_set <- ds_df[-in_partition,]
  test_set$pred <-  predict(fit, ds_df[-in_partition,])
  test_set$pred_prob <-  predict(fit, ds_df[-in_partition,], type = "prob")$Yes
  cm <- confusionMatrix(test_set$pred, test_set$Class)
  
  # Get AUC per Fold
  roc_eval <- test_set %>% 
    arrange(desc(pred_prob)) %>% 
    mutate(Class = ifelse(Class == "Yes",1,0)) %>%
    summarise(auc = auc(roc(Class,pred_prob)))
  # roc_vec <- as.vector(roc_eval$auc)
  # names(roc_vec) <- roc_eval$Resample
  data.frame(t(c(cm$overall, cm$byClass)),"AUC" = roc_eval$auc)
}
formula_byline <- Class ~ 
  as.factor(dep_hour) + 
  as.character(dep_wday) + 
  ttl_line +
  Temp_F + 
  Visibility + 
  WindSpeed
results_ho_byline <- tr_ds %>% group_by(Line) %>% do(testModelHoldout(.,tr_ctrl, method = "rf", formula_byline, ntree = 80))
```


```{r}
roc_eval <- rf_fit$pred %>% 
  group_by(Resample) %>% 
  arrange(desc(Yes)) %>% 
  mutate(obs = ifelse(obs == "Yes",1,0))
roc_eval %>% summarise(auc = auc(roc(obs,Yes)))
```

```{r}
results_dsrf_all <- testModel(tr_ds, tr_ctrl, method = "rf", formula, ntree=80)
results_dslrf_byline <- tr_ds %>% group_by(Line) %>% do(testModel(.,tr_ctrl, method = "rf", formula, ntree = 80))
```

```{r}
modelfit_byline <- tr_ds %>% group_by(Line) %>% do(fit = train(Class ~ 
                                                                 as.factor(dep_hour) + 
                                                                 as.character(dep_wday) +
                                                                 dep_mon + 
                                                                 ttl_line +
                                                                 Temp_F + 
                                                                 Visibility + 
                                                                 WindSpeed,
                                                               data = ., method = "rf", trControl = tr_ctrl, ntree = 80))
save(modelfit_byline, file = "../../DelayPredictor/modelfit_byline.rda")
```



```{r}
cmp_summ <- rbind(results_dslogit_all %>% mutate(Line="ALL", method = "Logistic Regression"),
results_dsrf_all %>% mutate(Line = "ALL", method = "Random Forrest"),
results_dslogit_byline %>% mutate(method = "Logistic Regression"),
results_dslrf_byline %>% mutate(method = "Random Forrest"))

cmp_summ <- cmp_summ %>% gather("Fold","auc",Fold1:Fold5)

```

```{r}
cmp_summ <- cmp_summ %>% 
  mutate(breakdown = ifelse(Line == "ALL","All_Line","By_Line")) %>% 
  mutate(Line = relevel(factor(Line), ref = "ALL")) %>% 
  filter(Line == "ALL")
ggplot(cmp_summ, aes(breakdown, auc, fill = method)) + geom_boxplot() + theme_bw()

library(gridExtra)

p1 <- ggplot(cmp_summ, aes(method, Accuracy, fill = method)) + geom_bar(stat="identity", position = 'dodge') + theme_bw() + ggtitle("Accuracy")+ guides(fill=FALSE) + xlab("") + scale_fill_hue(l=40)

p2 <- ggplot(cmp_summ, aes(method, Sensitivity, fill = method)) + geom_bar(stat="identity", position = 'dodge') + theme_bw() + ggtitle("Sensitivity")+ guides(fill=FALSE)+ xlab("")+ scale_fill_hue(l=40)

# ggplot(cmp_summ, aes(Line, Specificity, fill = method)) + geom_bar(stat="identity", position = 'dodge') + theme_bw() + ggtitle("Specificity")
p3 <- cmp_summ %>% group_by(Line, method) %>% summarise(meanauc = mean(auc)) %>% ggplot(aes(method,meanauc, fill = method)) + geom_bar(stat = 'identity', position = 'dodge') + theme_bw() +ggtitle("meanAUC")+ guides(fill=FALSE)+ xlab("")+ scale_fill_hue(l=40)

grid.arrange(p1,p2,p3, ncol=3)


```

#Downsamples  /Reweighting

```{r}
njt_featdaily <- njt_featdaily  %>% mutate(is_delayed = as.factor(number_delays>0))
daily_formula <- is_delayed ~ Line + as.character(dep_mon) + as.character(dep_wday) + Tmin + Tavg + PrecipTotal + SnowFall + WindSpeed
fit <- train(daily_formula, data = njt_featdaily, method = "glm", family = "binomial", tr_ctrl = trainControl(method="cv", number=2, savePred = TRUE, classProb = TRUE))
pred <-  predict(fit, njt_featdaily)
cm <- confusionMatrix(pred, njt_featdaily$number_delays)
```

